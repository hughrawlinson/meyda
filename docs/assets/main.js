!function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o,r=t(e),n=function(e){window.hasOwnProperty("webkitAudioContext")&&!window.hasOwnProperty("AudioContext")&&(window.AudioContext=webkitAudioContext),navigator.hasOwnProperty("webkitGetUserMedia")&&!navigator.hasOwnProperty("getUserMedia")&&(navigator.getUserMedia=webkitGetUserMedia,AudioContext.prototype.hasOwnProperty("createScriptProcessor")||(AudioContext.prototype.createScriptProcessor=AudioContext.prototype.createJavaScriptNode)),this.context=new AudioContext;var t=document.getElementById("elvisSong"),r=this.context.createMediaElementSource(t);r.connect(this.context.destination),this.meyda=Meyda.createMeydaAnalyzer({audioContext:this.context,source:r,bufferSize:e,windowingFunction:"blackman"}),o=this,this.initializeMicrophoneSampling()};n.prototype.initializeMicrophoneSampling=function(){var e=function(){if("suspended"===o.context.state){var e=function(){o.context.resume(),setTimeout((function(){"running"===o.context.state&&document.body.removeEventListener("touchend",e,!1)}),0)};document.body.addEventListener("touchend",e,!1)}};try{navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.getUserMedia||navigator.mediaDevices.getUserMedia;var t=function(e){document.getElementById("audioControl").style.display="none",console.log("User allowed microphone access."),console.log("Initializing AudioNode from MediaStream");var t=o.context.createMediaStreamSource(e);console.log("Setting Meyda Source to Microphone"),o.meyda.setSource(t),console.groupEnd()};console.log("Asking for permission..."),navigator.mediaDevices.getUserMedia({audio:!0}).then(t).catch((function(o){console.log(o),navigator.getUserMedia({audio:!0},t,(function(t){e()}))}))}catch(t){e()}},n.prototype.get=function(e){return o.context.resume(),o.meyda.get(e)};var a=["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"],i=1024,d=new n(i),c=new r.default.Scene,s=new r.default.PerspectiveCamera(40,1.6,.1,1e3),u=new r.default.LineBasicMaterial({color:65280});new r.default.LineBasicMaterial({color:65535});var l=function(e,t){for(var o=[],r=0;r<e;r++)o.push(Array.apply(null,Array(t)).map(Number.prototype.valueOf,0));return o}(20,i),f=new r.default.WebGLRenderer({canvas:document.querySelector("canvas")});function m(){f.domElement.style.width="100%",f.domElement.style.height="auto";var e=f.domElement.clientWidth/16*10;f.setPixelRatio(window.devicePixelRatio?window.devicePixelRatio:1),f.setSize(1.6*e,e),f.domElement.style.width="100%",f.domElement.style.height="auto",s.aspect=1.6*e/e,s.updateProjectionMatrix()}m(),window.addEventListener("resize",m);var p=new r.default.DirectionalLight(16777215,.5);p.position.set(0,1,1),c.add(p),s.position.z=5;var g=new r.default.Vector3(0,1,0),w=new r.default.Vector3(1,0,0),y=new r.default.Vector3(1,-6,-15),h=new r.default.ArrowHelper(g,y,1,16776960),v=new r.default.ArrowHelper(g,y,1,255),b=new r.default.ArrowHelper(w,y,1,16711935),M=new r.default.Group;c.add(h),c.add(v),c.add(b);for(var A=0;A<l.length;A++)if(l[A]){var x=new r.default.BufferGeometry,S=new Float32Array(3*l[A].length);x.addAttribute("position",new r.default.BufferAttribute(S,3)),x.setDrawRange(0,l[A].length);var C=new r.default.Line(x,u);M.add(C),S=C.geometry.attributes.position.array}var E=new r.default.BufferGeometry,U=new r.default.Line(E,u);S=new Float32Array(3072);E.addAttribute("position",new r.default.BufferAttribute(S,3)),E.setDrawRange(0,i),S=U.geometry.attributes.position.array,c.add(U),c.add(M);var P=null,L=document.querySelector("#chroma"),B=document.querySelector("#mfcc");!function e(){if(P=d.get(["amplitudeSpectrum","spectralCentroid","spectralRolloff","loudness","rms","chroma","mfcc"])){L&&P.chroma&&(L.innerHTML=P.chroma.reduce((function(e,t,o){return e+'\n          <div class="chroma-band" style="background-color: rgba(0,'+Math.round(255*t)+',0,1)">'+a[o]+"</div>"}),"")),B&&P.mfcc&&(B.innerHTML=P.mfcc.reduce((function(e,t,o){return e+'\n          <div class="mfcc-band" style="background-color: rgba(0,'+5*Math.round(t+25)+',0,1)">'+o+"</div>"}),"")),l.pop(),l.unshift(P.amplitudeSpectrum);for(var t=d.meyda._m.signal,o=0;o<l.length;o++){for(var r=M.children[o].geometry.attributes.position.array,n=0,u=0;u<3*l[o].length;u++)r[n++]=10.7+8*Math.log10(u/l[o].length),r[n++]=.1*l[o][u]-5,r[n++]=-15-o;M.children[o].geometry.attributes.position.needsUpdate=!0}if(P.spectralCentroid&&h.position.set(10.7+8*Math.log10(P.spectralCentroid/512),-6,-15),P.spectralRolloff){var m=P.spectralRolloff/22050;v.position.set(10.7+8*Math.log10(m),-6,-15)}if(P.rms&&b.position.set(-11,10*P.rms-5,-15),t){for(var p=U.geometry.attributes.position.array,g=0,w=0;w<i;w++)p[g++]=22*w/i-11,p[g++]=4+5*t[w],p[g++]=-25;U.geometry.attributes.position.needsUpdate=!0}}requestAnimationFrame(e),f.render(c,s)}()}(THREE);
